# This playbook syncronizes template files that should be applied to a repository.
# It ensures that the templates are rendered and copied to the appropriate locations,
# and maintains a log of the last sync operation.
#
# Environment detection logic:
#   - java:     pom.xml
#   - nodejs:   package.json (and no typescript dependency)
#   - typescript: package.json (with typescript dependency)
#   - dotnet:   *.sln or *.csproj
#   - ansible:  ansible.cfg
#   - default:  fallback if none detected
#
# To add a new environment, add a new subdirectory under templates/ and extend the detection logic here.

- name: Template Sync Playbook
  hosts: localhost
  vars:
    repo_path: "{{ repo_path | default(ansible_env.PWD) }}"
    # Determine environment flavor
    java_files: "{{ lookup('ansible.builtin.fileglob', repo_path + '/pom.xml', errors='ignore') }}"
    node_files: "{{ lookup('ansible.builtin.fileglob', repo_path + '/package.json', errors='ignore') }}"
    dotnet_files: "{{ lookup('ansible.builtin.fileglob', repo_path + '/*.sln', errors='ignore') + lookup('ansible.builtin.fileglob', repo_path + '/*.csproj', errors='ignore') }}"
    ansible_files: "{{ lookup('ansible.builtin.fileglob', repo_path + '/ansible.cfg', errors='ignore') }}"
    ts_files: "{{ lookup('ansible.builtin.fileglob', repo_path + '/package.json', errors='ignore') }}"
    # Add more as needed
    template_flavor: |
      {% if java_files %}java
      {% elif ansible_files %}ansible
      {% elif dotnet_files %}dotnet
      {% elif node_files %}
        {% set pkg = lookup('file', repo_path + '/package.json') | from_json %}
        {% if 'typescript' in (pkg.get('devDependencies', {}) | list + pkg.get('dependencies', {}) | list) %}typescript
        {% else %}nodejs
        {% endif %}
      {% else %}default
      {% endif %}
    template_dir: "{{ playbook_dir }}/templates/{{ template_flavor | trim }}"
    sync_log_path: "{{ repo_path }}/.template-sync/sync-report.json"

  tasks:
    - name: Read template config file
      ansible.builtin.slurp:
        src: "{{ template_dir }}/config.yml"
      register: template_config_raw

    - name: Parse template config
      set_fact:
        template_config: "{{ template_config_raw['content'] | b64decode | from_yaml }}"

    - name: Ensure all destination directories exist
      ansible.builtin.file:
        path: "{{ repo_path }}/{{ item.value | dirname }}"
        state: directory
        mode: '0755'
      loop: "{{ template_config | dict2items }}"
      loop_control:
        label: "{{ item.value }}"

    - name: Check if destination file exists
      ansible.builtin.stat:
        path: "{{ repo_path }}/{{ item.value }}"
      loop: "{{ template_config | dict2items }}"
      register: dest_file_stats
      loop_control:
        label: "{{ item.value }}"

    - name: Copy/render template files as per config if destination does not exist
      ansible.builtin.template:
        src: >-
          {{ (template_dir + '/' + item.0.key) if (lookup('ansible.builtin.fileglob', template_dir + '/' + item.0.key, errors='ignore')) else (playbook_dir + '/templates/' + item.0.key) }}
        dest: "{{ repo_path }}/{{ item.0.value }}"
        mode: '0644'
      loop: "{{ lookup('ansible.builtin.zip', template_config | dict2items, dest_file_stats.results) }}"
      when: not item.1.stat.exists
      loop_control:
        label: "{{ item.0.key }} -> {{ item.0.value }} (if not exists)"
